{% extends 'base.html' %}

{% block content %}

<style>
    h2 {
        text-align: center;
    }
    #grades-table {
        border: 1px solid black;
        width: 100%;
        align-items: center;
        min-width: max-content;
    }
    tr, th, td {
        border: 1px solid black;
        text-align: center;
    }
</style>

<h2>Щоденник</h2>

{% if user.is_staff or user.is_superuser %}
    <div class="links">
        <a href="{% url 'add-student' %}">Додати студента</a>
        <a href="{% url 'add-subject' %}">Додати предмет</a>
        <a href="{% url 'add-grade' %}">Додати оцінку студенту</a>
    </div>
{% endif %}

<div id="scroll-container">
    <table id="grades-table">

        <thead>
            <tr>
                <th rowspan="2">Учень</th>
                <th colspan="{{ subjects|length }}">Предмет</th>
            </tr>
            <tr>
                {% for subject in subjects %}
                    {% if user.is.staff or user.is_superuser %}
                        <th><a href="{% url 'edit-subject' subject.id %}">{{ subject.name }}</a></th>
                    {% else %}
                        <th>{{ subject.name }}</th>
                    {% endif %}
                {% endfor %}
            </tr>
        </thead>

        <tbody>
            {% for student in students %}
            <tr>
                {% if user.is_staff or user.is_superuser %}
                    <td><a href="{% url 'edit-student' student.id %}">{{ student.first_name }} {{student.last_name}}</a></td>
                {% else %}
                    <td>{{ student.first_name }} {{student.last_name}}</td>
                {% endif %}
                {% for subject in subjects %}
                    <td data-student="{{ student.id }}" data-subject="{{ subject.id }}"></td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>

    </table>
</div>
<!-- <pre>{{ grade_dict_json }}</pre> -->

<script>

    document.addEventListener('DOMContentLoaded', function() {
        const gradeDict = JSON.parse('{{ grade_dict_json|escapejs }}');
        const cells = document.querySelectorAll('td[data-student][data-subject]');

        cells.forEach(cell => {
            const studentId = cell.getAttribute('data-student');
            const subjectId = cell.getAttribute('data-subject');
            const key = `${studentId}_${subjectId}`;

            const grade = gradeDict[key];
            if (grade && grade.length > 0) {
                cell.innerHTML = grade.map(g => `${g.grade}`).join('<br>');

            }
            if (grade && grade.length > 0) {
                cell.innerHTML = grade.map((g, index) => {
                    return `<a href ="/edit-grade/${g.id}/">${g.grade}</a>`;
                }).join('<br>');
            }
        });

        const subjectHeeaders = document.querySelectorAll('#grades-table thead tr:nth-child(2) th');

        if (subjectHeeaders.length > 5) {
            const scrollContainer = document.getElementById('scroll-container');
            scrollContainer.style.overflowX = 'auto';
            scrollContainer.style.display = 'black';
        } else {
            const scrollContainer = document.getElementById('scroll-container');
            scrollContainer.style.overflowX = 'hidden';
        }
    });
</script>


{% endblock %}